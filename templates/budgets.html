{% extends 'base.html' %}

{% block title %}
Budgets - Finance Tracker
{% endblock %}

{% block content %}
<style>
    .progress-bar-overspent {
        background-color: #dc3545 !important;
    }
    .progress-bar-warning {
        background-color: #ffc107 !important;
    }
    .progress-bar-safe {
        background-color: #28a745 !important;
    }
    .budget-card {
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    .budget-card.overspent {
        border-left-color: #dc3545;
    }
    .budget-card.warning {
        border-left-color: #ffc107;
    }
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
    }
    .popup-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        width: 400px;
    }
    .close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 24px;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Budget Management</h2>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" onclick="openAddBudgetPopup()">
                <i class="fas fa-plus"></i> Add Budget
            </button>
        </div>
    </div>

    <!-- Budget Overview Cards -->
    <div class="row mt-4">
        {% if budgets %}
            {% for budget in budgets %}
            <div class="col-md-6 mb-3">
                <div class="card budget-card {% if budget.is_overspent %}overspent{% elif budget.percentage_used > 80 %}warning{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">{{ budget.category }}</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editBudget({{ budget.id }}, {{ budget.allocated_amount }})">Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteBudget({{ budget.id }})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col">
                                <small class="text-muted">Allocated</small>
                                <div class="fw-bold">₹{{ "%.2f"|format(budget.allocated_amount) }}</div>
                            </div>
                            <div class="col">
                                <small class="text-muted">Spent</small>
                                <div class="fw-bold {% if budget.is_overspent %}text-danger{% endif %}">₹{{ "%.2f"|format(budget.spent_amount) }}</div>
                            </div>
                            <div class="col">
                                <small class="text-muted">Remaining</small>
                                <div class="fw-bold {% if budget.remaining < 0 %}text-danger{% else %}text-success{% endif %}">₹{{ "%.2f"|format(budget.remaining) }}</div>
                            </div>
                        </div>

                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar {% if budget.is_overspent %}progress-bar-overspent{% elif budget.percentage_used > 80 %}progress-bar-warning{% else %}progress-bar-safe{% endif %}" 
                                 role="progressbar" 
                                 style="width: {% if budget.percentage_used > 100 %}100{% else %}{{ budget.percentage_used }}{% endif %}%">
                            </div>
                        </div>

                        <small class="text-muted">
                            {{ "%.1f"|format(budget.percentage_used) }}% used
                            {% if budget.is_overspent %}
                                <span class="text-danger fw-bold">• OVER BUDGET!</span>
                            {% elif budget.percentage_used > 80 %}
                                <span class="text-warning fw-bold">• Approaching limit</span>
                            {% endif %}
                        </small>

                        <div class="mt-2">
                            <small class="text-muted">
                                Period: {{ budget.period|title }} 
                                ({{ budget.start_date }} {% if budget.end_date %}to {{ budget.end_date }}{% endif %})
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No budgets created yet</h4>
                    <p class="text-muted">Create your first budget to start tracking your spending!</p>
                    <button class="btn btn-primary" onclick="openAddBudgetPopup()">
                        <i class="fas fa-plus"></i> Create Budget
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Budget Popup -->
<div id="addBudgetPopup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closeAddBudgetPopup()">&times;</span>
        <h4>Add New Budget</h4>
        <form action="{{ url_for('budgets.add_budget') }}" method="post">
            <div class="mb-3">
                <label for="category" class="form-label">Category:</label>
                <select id="category" name="category" class="form-select" required>
                    <option value="">Select Category</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Food">Food</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Education">Education</option>
                    <option value="Travel expenses">Travel expenses</option>
                    <option value="Gifts">Gifts</option>
                    <option value="Rent">Rent</option>
                    <option value="Subscriptions">Subscriptions</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="allocated_amount" class="form-label">Budget Amount (₹):</label>
                <input type="number" id="allocated_amount" name="allocated_amount" class="form-control" min="1" step="0.01" required>
            </div>
            <div class="mb-3">
                <label for="period" class="form-label">Period:</label>
                <select id="period" name="period" class="form-select" required>
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="start_date" class="form-label">Start Date:</label>
                <input type="date" id="start_date" name="start_date" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="end_date" class="form-label">End Date (Optional):</label>
                <input type="date" id="end_date" name="end_date" class="form-control">
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="closeAddBudgetPopup()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Budget</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Budget Popup -->
<div id="editBudgetPopup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closeEditBudgetPopup()">&times;</span>
        <h4>Edit Budget</h4>
        <form id="editBudgetForm" method="post">
            <div class="mb-3">
                <label for="edit_allocated_amount" class="form-label">Budget Amount (₹):</label>
                <input type="number" id="edit_allocated_amount" name="allocated_amount" class="form-control" min="1" step="0.01" required>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="closeEditBudgetPopup()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Budget</button>
            </div>
        </form>
    </div>
</div>

<script>
function openAddBudgetPopup() {
    document.getElementById("addBudgetPopup").style.display = "block";
}

function closeAddBudgetPopup() {
    document.getElementById("addBudgetPopup").style.display = "none";
}

function openEditBudgetPopup() {
    document.getElementById("editBudgetPopup").style.display = "block";
}

function closeEditBudgetPopup() {
    document.getElementById("editBudgetPopup").style.display = "none";
}

function editBudget(budgetId, currentAmount) {
    document.getElementById("edit_allocated_amount").value = currentAmount;
    document.getElementById("editBudgetForm").action = "{{ url_for('budgets.update_budget', budget_id=0) }}".replace('0', budgetId);
    openEditBudgetPopup();
}

function deleteBudget(budgetId) {
    if (confirm('Are you sure you want to delete this budget?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('budgets.delete_budget', budget_id=0) }}".replace('0', budgetId);
        document.body.appendChild(form);
        form.submit();
    }
}

// Set default start date to current date
document.getElementById('start_date').value = new Date().toISOString().split('T')[0];
</script>
{% endblock %}